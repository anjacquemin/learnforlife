<div data-controller="record" data-total-unlock-items = <%=@total_unlocked_items%>>
  <div class="theme-title subtheme-show record-show">
    <div class="quizz-level-title">
      <%= cl_image_tag @record.quizz.category.photo.key, height: 40 %>
      <h2><%= "#{@record.quizz.name.upcase} - #{@record.quizz_level.name.capitalize}" %></h2>
      <%= render "shared/level_stars", level: @record.quizz_level %>
    </div>
    <div class="end-quizz-sentence">
      <p>Tu as fini la session / ou nouveau record ! Bravo ! </p>
    </div>
  </div>
  <div class="my-5"></div>
  <div class="key-results">
    <div class = "crowns-display">
      <%= render "shared/crowns", crown_class: "completed-crown", number: @record.completion %>
      <%= render "shared/crowns", crown_class: "uncompleted-crown", number: 3-@record.completion %>
    </div>
    <div class="sub-key-results">
      <div class="completion">
        <i class=""></i>
        <div class="completion-percentage">
          <p><%= @record.score_percentage%>%</p>
        </div>
      </div>
      <div class="time-display">
        <i class="fa-solid fa-stopwatch"></i>
        <p><%= @record.seconds_duration%>.</p>
        <p><%= @record.milliseconds_duration%> s</p>
      </div>
    </div>
  </div>
  <%# <div class="my-5"></div> %>
  <div class="container">
    <div class="row">
      <div class="results progression col-lg-6">
        <div class="banner">
          <h2>Progression</h2>
        </div>
        <div class="record-card">
          <div class="xp-gold-ranking">
            <div class="xp-gold">
              <div class="gold">
                <%= image_tag 'pieces.png' %>
                <p> <%= @gold_win%> </p>
              </div>
              <div class= "flashcard-won">
                <div class="percentage-details">
                <div>
                  <p>icon</p>
                </div>
                  <div class="flashcards-count">
                    <div class="flashcards-total">
                      <div class="progressbar-wrapper">
                        <div title="theme_completion" class="progressbar theme-completion" style=<%="width:10%"%>></div>
                      </div>
                      <div class= "flashcard-number">
                        <p>0/10</p>
                      </div>
                    </div>
                    <div class= "thin-line-height">
                      <p> +  <%= @xp_win  %> </p>
                    </div>
                  </div>
                </div>
              </div>
              <div class= "flashcard-won">
                <div class="percentage-details">
                <div>
                  <p>icon</p>
                </div>
                  <div class="flashcards-count">
                    <div class="flashcards-total">
                      <div class="progressbar-wrapper">
                        <div title="theme_completion" class="progressbar theme-completion" style=<%="width:10%"%>></div>
                      </div>
                      <div class= "flashcard-number">
                        <p>0/10</p>
                      </div>
                    </div>
                    <div class= "thin-line-height">
                      <p> + XXX </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class= "ranking">
              <h2>0<sup>ème</sup></h2>
              <p>/150</p>
            </div>
          </div>
          <div class="theme-progress">
              <% @user = current_user %>
              <% subtheme =  @record.quizz.category.subtheme%>
              <div class="subtheme-card-enhanced">
                <% subtheme_progress = @user.subtheme_progresses.find_by(subtheme: subtheme) %>
                <% if subtheme && @subtheme_unlocked = (subtheme_progress &.unlocked)  %>
                  <%@subtheme_blur = 3 %>
                <% end %>
                <div class="content" style='filter: blur(<%=@level_blur%>px)'>
                  <h2><%= subtheme.name %></h2>
                  <div class= "achievement-count" style='filter: blur(<%=@level_blur%>px)'>
                    <%= image_tag "crown.png" %>
                    <% total_subthemes_crowns = subtheme.quizz_levels.count * 3 %>
                    <% user_total_crowns =  subtheme.records.where(user: current_user, crown_or_sphere: "crown").group(:quizz_level_id).maximum(:completion).sum{|k,v|v} %>
                    <% user_total_spheres =  subtheme.records.where(user: current_user, crown_or_sphere: "sphere").group(:quizz_level_id).maximum(:completion).sum{|k,v|v} %>
                    <% @user_total = user_total_crowns + user_total_spheres %>
                    <% @completion = (subtheme.quizz_levels.count.zero? ? 0 : (@user_total.to_f / (total_subthemes_crowns) * 100)).round() %>
                    <p> <%= @user_total %> / <%= total_subthemes_crowns %>
                  </div>
                </div>
                <div class="circle-container" style='filter: blur(<%=@level_blur%>px)'>
                  <div class="circle-wrap "
                    data-record-target = "circleDiv<%=0%>"
                    data-rotate<%=0%> = <%=@completion*1.8%>>
                    <div class="circle">
                      <div class="mask half">
                        <div class="fill" data-record-target= "circle<%=0%>"></div>
                      </div>
                      <div class="mask full" data-record-target= "circle<%=0 %>">
                        <div class="fill" data-record-target= "circle<%=0%>"></div>
                      </div>
                      <div class="inside-circle"> <%=@completion%>%</div>
                    </div>
                  </div>
                </div>
                <div class="badge-progress">
                  <% if @subtheme_unlocked %>
                    <div class="badge-display">
                      <% subtheme.categories.each do |category| %>
                        <% @category_unlock = current_user.category_progresses.find_by(category: category) %>
                        <% if @category_unlock &.unlocked %>
                          <% @opacity = 1  %>
                        <% else %>
                          <% @opacity = 0.15 %>
                        <% end %>
                        <%= cl_image_tag category.photo.key, height: 30, crop: :fill, style: "opacity:#{@opacity}" %>
                      <% end %>
                    </div>
                    <% else %>
                      <%= image_tag "cadenas.png", height: 50, style: "opacity:0.4" %>
                  <% end %>
                </div>
              </div>
          </div>
        </div>
      </div>
      <div class="results answers col-lg-6">
        <div class="banner">
          <h2>Réponse</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
            <div class= "result-number">
              <div class="good-answer-count">
                <%= image_tag 'verifie.png' %>
                <p><%= @record.score_percentage * @number_of_questions / 100%></p>
              </div>
              <div class="bad-answer-count">
                <%= image_tag 'annuler.png' %>
                <p><%= ((100-@record.score_percentage) * @number_of_questions) / 100%></p>
              </div>
            </div>
            <div class="all-answers">
              <hr class="horizontal-divider-light">
              <% @synthesis.each_with_index do |question_synthese, index| %>
                <div class= "unique-answer">
                  <div class= "question-number">
                    <p> <%= index %> </p>
                  </div>
                  <div class = "question-answer">
                    <p> <strong><%=question_synthese[:question].capitalize%></strong> </p>
                    <p><%=question_synthese[:answer]%> - Réponse : <%=question_synthese[:user_answer]%></p>
                  </div>
                  <% if question_synthese[:is_good] %>
                    <%= image_tag 'verifie.png', height: 30 %>
                  <% else %>
                    <%= image_tag 'annuler.png', height: 30 %>
                  <% end %>
                </div>
                <hr class="horizontal-divider-light">
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="results leaderboard col-lg-6">
        <div class="banner">
          <h2>Leaderboard</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
          </div>
        </div>
      </div>
      <div class="results unlocked-levels col-lg-6">
        <div class="banner">
          <h2>Challenge</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
            <% if @unlocked_items && @unlocked_items[:quizz_level]  %>
              <% sentence = "Niveau #{@unlocked_items[:quizz_level].name}  débloqué !" %>
              <% quizz_to_display = @unlocked_items[:quizz_level].quizz %>
              <% if @unlocked_items && @unlocked_items[:quizz] %>
                <% sentence = "Quizz #{@unlocked_items[:quizz].name}  débloqué !" %>
                <% quizz_to_display = @unlocked_items[:quizz] %>
              <% end %>
              <% if  @unlocked_items && @unlocked_items[:category] %>
                <% sentence = "Quizz XXX débloqué !" %>
              <% end %>
              <p><%= sentence %></p>
              <div class="quizz-card">
                <% @user_quizz_progress_unlocked = true %>
                <%= render "shared/card_display", quizz: quizz_to_display %>
                <%= render "shared/level_display", quizz: quizz_to_display %>
              </div>
            <% else %>
              <p>Rien de nouveau de débloqué, essaye d'améliorer ton record ! </p>
              <% @user_quizz_progress_unlocked = true %>
            <div class="quizz-card">
              <%= render "shared/card_display", quizz: @record.quizz %>
              <%= render "shared/level_display", quizz: @record.quizz %>
            </div>
            <% end %>
          </div>
          </div>
        </div>
      </div>
    </div>


    <%= link_to "continue", themes_path, class: "btn btn-purple my-4" %>

    <% @count = 0 %>
    <% if  @unlocked_items && @unlocked_items[:category] %>
      <% unlocked_category_sentence = "<p> Félicitation !!! </p> Tous les quizz #{@unlocked_items[:category].name.upcase} de #{@unlocked_items[:category].subtheme.theme_level.name} sont terminés\n" %>

      <%if @unlocked_items[:theme_level_and_children]  %>
        <%if unlocked_theme_level = @unlocked_items[:theme_level_and_children][:theme_level] %>
          	<% unlocked_category_sentence += "<p>#{unlocked_theme_level.theme.name.upcase} - #{unlocked_theme_level.name.upcase} débloqué ! </p>" %>
            <% unlocked_subthemes = @unlocked_items[:theme_level_and_children][:subthemes] %>
            <%= unlocked_category_sentence += " #{unlocked_subthemes.count} nouvelles thématiques : #{unlocked_subthemes.map{|subtheme| subtheme.name}.join(", ")}" %>
            <% @count += 1 %>
            <%= render 'achievement_modal', type: "theme_level", sentence: unlocked_category_sentence%>
        <% end %>

        <%if unlocked_quizz_levels = @unlocked_items[:theme_level_and_children][:quizz_levels] %>
          <% unlocked_quizz_levels.each do |quizz_level| %>
            <% @count += 1 %>
            <%= render 'achievement_modal',type: "quizz_level", sentence: "<p> Félicitation !!! </p> Niveau #{quizz_level.name.upcase} du quizz #{quizz_level.category.name.upcase} - #{quizz_level.quizz.name.upcase}  débloqué", quizz: quizz_level.quizz%>
          <% end %>
        <% end %>
      <% elsif %>
        <% @count += 1 %>
        <%= render 'achievement_modal', type: "category", sentence: unlocked_category_sentence%>
      <% end %>
    <% end %>

    <% if @unlocked_items && @unlocked_items[:quizz] %>
      <% @count += 1 %>
      <%= render 'achievement_modal', type: "quizz", sentence: "<p> Félicitation !!! </p> Quizz #{@unlocked_items[:quizz].category.name.upcase} - #{@unlocked_items[:quizz].name.upcase} débloqué !", quizz: @unlocked_items[:quizz]%>
    <% end %>

    <% if @unlocked_items && @unlocked_items[:quizz_level] %>
      <% @count += 1 %>
      <%= render 'achievement_modal',type: "quizz_level", sentence: "<p> Félicitation !!! </p> Niveau #{@unlocked_items[:quizz_level].name.upcase} du quizz  #{@unlocked_items[:quizz_level].quizz.name.upcase} débloqué !", quizz: @unlocked_items[:quizz_level].quizz%>
    <% end %>


  </div>
</div>
