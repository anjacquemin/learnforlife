<div data-controller="record" data-total-unlock-items = <%=@total_unlocked_items%>>
  <div class="theme-title subtheme-show record-show">
    <div class="quizz-level-title">
      <%= cl_image_tag @record.quizz.category.photo.key, height: 50 %>
      <h2><%= "#{@record.quizz.name.upcase} - #{@record.quizz_level.name.capitalize}" %></h2>
      <% 3.times do %>
        <%= image_tag 'star1.png' %>
      <% end %>
    </div>
    <div class="end-quizz-sentence">
      <p>Tu as fini la session / ou nouveau record ! Bravo ! </p>
    </div>
  </div>
  <div class="my-5"></div>
  <div class="key-results">
    <div class = "crowns-display">
      <%= render "shared/crowns", crown_class: "completed-crown", number: @record.completion %>
      <%= render "shared/crowns", crown_class: "uncompleted-crown", number: 3-@record.completion %>
    </div>
    <div class="sub-key-results">
      <div class="completion">
        <i class=""></i>
        <div class="completion-percentage">
          <p><%= @record.score_percentage * @number_of_questions / 100%>%</p>
        </div>
      </div>
      <div class="time-display">
        <i class="fa-solid fa-stopwatch"></i>
        <p><%= @record.seconds_duration%>.</p>
        <p id="second-duration"><%= @record.milliseconds_duration%> s</p>
      </div>
    </div>
  </div>
  <div class="my-5"></div>
  <div class="container">
    <div class="row">
      <div class="results col-lg-6">
        <div class="banner">
          <h2>Progression</h2>
        </div>
        <div class="record-card">
          <div class="xp-gold-ranking">
            <div class="xp-gold">
              <div class="gold">
                <%= image_tag 'pieces.png' %>
                <p> <%= @gold_win%> </p>
              </div>
              <div class= "flashcard-won">
                <div class="percentage-details">
                <div>
                  <p>icon</p>
                </div>
                  <div class="flashcards-count">
                    <div class="flashcards-total">
                      <div class="progressbar-wrapper">
                        <div title="theme_completion" class="progressbar theme-completion" style=<%="width:10%"%>></div>
                      </div>
                      <div class= "flashcard-number">
                        <p>0/10</p>
                      </div>
                    </div>
                    <div class= "thin-line-height">
                      <p> +  <%= @xp_win  %> </p>
                    </div>
                  </div>
                </div>
              </div>
              <div class= "flashcard-won">
                <div class="percentage-details">
                <div>
                  <p>icon</p>
                </div>
                  <div class="flashcards-count">
                    <div class="flashcards-total">
                      <div class="progressbar-wrapper">
                        <div title="theme_completion" class="progressbar theme-completion" style=<%="width:10%"%>></div>
                      </div>
                      <div class= "flashcard-number">
                        <p>0/10</p>
                      </div>
                    </div>
                    <div class= "thin-line-height">
                      <p> + XXX </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class= "ranking">
              <h2>0<sup>ème</sup></h2>
              <p>/150</p>
            </div>
          </div>
          <div class="theme-progress">
              <% @user = current_user %>
              <% subtheme =  @record.quizz.category.subtheme%>
              <div class="subtheme-card-enhanced">
                <% subtheme_progress = @user.subtheme_progresses.find_by(subtheme: subtheme) %>
                <% if subtheme && @subtheme_unlocked = (subtheme_progress &.unlocked)  %>
                  <%@subtheme_blur = 3 %>
                <% end %>
                <div class="content" style='filter: blur(<%=@level_blur%>px)'>
                  <h2><%= subtheme.name %></h2>
                  <div class= "achievement-count" style='filter: blur(<%=@level_blur%>px)'>
                    <%= image_tag "crown.png" %>
                    <p>2 / 35 </p>
                  </div>
                </div>
                <div class="circle-container" style='filter: blur(<%=@level_blur%>px)'>
                  <div class="circle-wrap "
                    data-theme-show-target = "circleDiv<%=1%>"
                    data-rotate<%=1%> = <%=3.6%>>
                    <div class="circle">
                      <div class="mask half">
                        <div class="fill" data-theme-show-target= "circle<%=1%>"></div>
                      </div>
                      <div class="mask full" data-theme-show-target= "circle<%=1%>">
                        <div class="fill" data-theme-show-target= "circle<%=1%>"></div>
                      </div>
                      <div class="inside-circle"> <%= 99 %>%</div>
                    </div>
                  </div>
                </div>
                <div class="badge-progress">
                  <% if @subtheme_unlocked %>
                    <div class="badge-display">
                      <% subtheme.categories.each do |category| %>
                        <% @category_unlock = current_user.category_progresses.find_by(category: category) %>
                        <% if @category_unlock &.unlocked %>
                          <% @opacity = 1  %>
                        <% else %>
                          <% @opacity = 0.15 %>
                        <% end %>
                        <%= cl_image_tag category.photo.key, height: 30, crop: :fill, style: "opacity:#{@opacity}" %>
                      <% end %>
                    </div>
                    <% else %>
                      <%= image_tag "cadenas.png", height: 50, style: "opacity:0.4" %>
                  <% end %>
                </div>
              </div>
          </div>
        </div>
      </div>
      <div class="results answers col-lg-6">
        <div class="banner">
          <h2>Réponse</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
            <div class= "result-number">
              <div class="good-answer-count">
                <%= image_tag 'verifie.png' %>
                <p><%= @record.score_percentage * @number_of_questions / 100%></p>
              </div>
              <div class="bad-answer-count">
                <%= image_tag 'annuler.png' %>
                <p><%= ((100-@record.score_percentage) * @number_of_questions) / 100%></p>
              </div>
            </div>
            <div class="all-answers">
              <hr class="horizontal-divider-light">
              <% @synthesis.each_with_index do |question_synthese, index| %>
                <div class= "unique-answer">
                  <div class= "question-number">
                    <p> <%= index %> </p>
                  </div>
                  <div class = "question-answer">
                    <p> <strong><%=question_synthese[:question]%></strong> </p>
                    <p><%=question_synthese[:answer]%> - Réponse : <%=question_synthese[:user_answer]%></p>
                  </div>
                  <%= image_tag 'verifie.png', height: 30 %>
                </div>
                <hr class="horizontal-divider-light">
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="results leaderboard col-lg-6">
        <div class="banner">
          <h2>Leaderboard</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
          </div>
        </div>
      </div>
      <div class="results unlocked-levels col-lg-6">
        <div class="banner">
          <h2>Challenge</h2>
        </div>
        <div class="record-card">
          <div class="white-container">
            <% if @unlocked_items && @unlocked_items[:quizz_level]  %>
              <p>strongEssaye le nouveau quizz débloqué</p>
              <div class="quizz-card">
                <%= render "shared/card_display", quizz: @record.quizz %>
                <%= render "shared/level_display", quizz: @record.quizz %>
              </div>
            <% else %>
              <p>Rien de nouveau de débloquer, essaye d'améliorer ton record ! </p>
            <div class="quizz-card">
              <%= render "shared/card_display", quizz: @record.quizz %>
              <%= render "shared/level_display", quizz: @record.quizz %>
            </div>
            <% end %>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%= link_to "continue", themes_path, class: "btn btn-purple my-4" %>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop1" style="height: 40px; background-color:black;">

  <% @count = 0 %>
  <% if @unlocked_items && @unlocked_items[:quizz_level] %>
    <% @count += 1 %>
    <%= render 'achievement_modal',type: "quizz_level", sentence: "Félicitation, vous avez débloquez le niveau #{@unlocked_items[:quizz_level].name} du quizz #{@unlocked_items[:quizz_level].quizz.name}", quizz:@unlocked_items[:quizz_level].quizz%>
  <% end %>

  <% if @unlocked_items && @unlocked_items[:quizz] %>
    <% @count += 1 %>
    <%= render 'achievement_modal', type: "quizz", sentence: "Félicitation, vous avez débloquez le quizz #{@unlocked_items[:quizz].name}", quizz: @unlocked_items[:quizz]%>
  <% end %>

  <% if  @unlocked_items && @unlocked_items[:category] %>
    <% @count += 1 %>
    <%= render 'achievement_modal', type: "category", sentence: "Félicitation, vous avez terminé tous les quizz #{@unlocked_items[:category].name} de niveau #{@unlocked_items[:category].subtheme.theme_level.name} ! Et avez débloqué #{@unlocked_items[:theme_level].name} de #{@unlocked_items[:theme_level].theme.name}"%>
  <% end %>
</div>
